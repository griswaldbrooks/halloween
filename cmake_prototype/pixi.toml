[project]
name = "cmake_prototype"
version = "0.1.0"
description = "CMake-based Arduino library with GoogleTest and coverage"
channels = ["conda-forge"]
platforms = ["linux-64"]

[dependencies]
cmake = ">=3.14"
gtest = "*"
gcovr = "*"
lcov = "*"
ninja = "*"
cxx-compiler = "*"

[tasks]
# === CMake Configuration ===
configure = "cmake -B build -S . -DCMAKE_BUILD_TYPE=Debug -G Ninja"
reconfigure = { cmd = "rm -rf build && cmake -B build -S . -DCMAKE_BUILD_TYPE=Debug -G Ninja", description = "Clean and reconfigure CMake" }

# === Build ===
build = { cmd = "cmake --build build", depends-on = ["configure"] }
rebuild = { cmd = "rm -rf build && cmake -B build -S . -DCMAKE_BUILD_TYPE=Debug -G Ninja && cmake --build build", description = "Full rebuild from scratch" }

# === Testing ===
test = { cmd = "cd build && ctest --output-on-failure --verbose", depends-on = ["build"], description = "Run all GoogleTest unit tests" }
test-quiet = { cmd = "cd build && ctest --output-on-failure", depends-on = ["build"], description = "Run tests with less output" }

# === Coverage Generation ===
# Generate coverage in SonarQube XML format (for SonarCloud)
# Step 1: Generate with project root (so gcov can find .gcno files)
# Step 2: Post-process XML to add cmake_prototype/ prefix for SonarCloud path matching
# This solves: SonarCloud resolves paths from repo root, not projectBaseDir
coverage-xml = { cmd = "cd build && gcovr --sonarqube ../coverage.xml --root .. --filter '../lib/.*' --exclude-throw-branches --exclude-unreachable-branches && sed -i 's|<file path=\"lib/|<file path=\"cmake_prototype/lib/|g' ../coverage.xml", depends-on = ["test"], description = "Generate SonarQube XML coverage report" }

# Generate coverage in HTML format (for human viewing)
coverage-html = { cmd = "mkdir -p coverage && cd build && gcovr --html-details ../coverage/index.html --root .. --filter '../lib/.*' --exclude-throw-branches --exclude-unreachable-branches", depends-on = ["test"], description = "Generate HTML coverage report" }

# Generate coverage in terminal
coverage-terminal = { cmd = "cd build && gcovr --root .. --filter '../lib/.*' --exclude-throw-branches --exclude-unreachable-branches", depends-on = ["test"], description = "Show coverage in terminal" }

# Alias for CI/CD compatibility
coverage-summary = { depends-on = ["coverage-terminal"], description = "Show coverage summary (alias for coverage-terminal)" }

# Combined coverage (both XML and HTML)
coverage = { depends-on = ["coverage-xml", "coverage-html", "coverage-terminal"], description = "Generate all coverage reports" }

# === View Coverage ===
view-coverage = { cmd = "xdg-open coverage/index.html", description = "Open HTML coverage report in browser" }

# === Arduino Compilation (requires arduino-cli outside pixi) ===
# Note: arduino-cli is not available in conda-forge, install separately
arduino-compile = { cmd = "arduino-cli compile --fqbn arduino:avr:leonardo arduino_sketch/example_sketch", description = "Compile Arduino sketch (requires arduino-cli)" }
arduino-upload = { cmd = "arduino-cli upload -p /dev/ttyACM0 --fqbn arduino:avr:leonardo arduino_sketch/example_sketch", description = "Upload sketch to Arduino (requires arduino-cli and hardware)" }

# === Cleanup ===
clean = { cmd = "rm -rf build coverage coverage.xml", description = "Remove all build artifacts and coverage reports" }

# === Status ===
status = { cmd = """
echo '=== CMake Prototype Status ==='
echo ''
echo 'Available commands:'
echo '  pixi run test             - Run GoogleTest unit tests'
echo '  pixi run coverage         - Generate coverage reports'
echo '  pixi run view-coverage    - Open coverage in browser'
echo '  pixi run arduino-compile  - Compile Arduino sketch'
echo ''
echo 'Quick workflow:'
echo '  1. pixi run test          # Run tests'
echo '  2. pixi run coverage      # Generate coverage'
echo '  3. pixi run view-coverage # View results'
echo ''
echo 'Structure:'
echo '  lib/          - Shared library (single source of truth)'
echo '  test/         - GoogleTest unit tests'
echo '  arduino_sketch/ - Arduino sketch using library'
echo '  build/        - CMake build directory (gitignored)'
echo ''
""", description = "Show project status and available commands" }

[feature.dev.dependencies]
# Additional development dependencies
clang-format = "*"

[feature.dev.tasks]
format = { cmd = "find lib test -name '*.cpp' -o -name '*.h' | xargs clang-format -i", description = "Format code with clang-format" }
