# SonarCloud Project Configuration
# Last Updated: 2025-11-11
#
# C++ COVERAGE SOLUTION (2025-11-11): Using native gcov format with CFamily sensor
# - Root cause: Generic Coverage Report sensor runs BEFORE CFamily sensor
# - Coverage cannot be applied to files that haven't been indexed yet
# - Solution: Use native .gcov files processed by CFamily sensor during analysis phase
# - Reference: hatching_egg/SONARCLOUD_COVERAGE_ROOT_CAUSE.md
# - Status: Implementing native gcov solution
#
# WORKING: Python (92%), JavaScript (90.6%), window_spider_trigger (96.6%)
# IMPLEMENTING: C++ native gcov solution (85.9% local coverage)
#
# SonarCloud configuration for Halloween Monorepo
sonar.projectKey=griswaldbrooks_halloween
sonar.organization=griswaldbrooks

# Project metadata
sonar.projectName=Halloween Haunted House
sonar.projectVersion=1.0.0

# Source code
sonar.sources=.
# C++ test files (test_*.cpp) are excluded - they don't need coverage analysis
# coverage_compilation.cpp is INCLUDED - it's the entry point for SonarCloud to discover header files
# Header files (.h) with actual logic are analyzed through coverage_compilation.cpp includes
sonar.exclusions=**/node_modules/**,**/coverage*/**,**/*.test.js,**/*.spec.js,**/test*.js,**/test*.py,**/test_*.cpp,**/pixi.lock,**/.pixi/**,**/2025/**,**/.github/**,**/arduino/**/*.ino

# Test files
# C++ test files (test_*.cpp) are now excluded from analysis via sonar.exclusions
# Header files (.h) are included in compilation DB via coverage_compilation.cpp helper
sonar.tests=.
sonar.test.inclusions=**/*.test.js,**/*.spec.js,**/test*.js,**/test*.py

# Language-specific coverage paths
# JavaScript
sonar.javascript.lcov.reportPaths=window_spider_trigger/coverage/lcov.info,spider_crawl_projection/coverage/lcov.info,hatching_egg/coverage-js/lcov.info

# C++ (hatching_egg Arduino header files + cmake_prototype)
# hatching_egg: 85.9% local (1621/1888 lines, 171 GoogleTest tests)
# cmake_prototype: 100% local (native .gcov format)
# Analysis enabled using compilation database from bear/cmake
# Using native .gcov format processed by CFamily sensor during analysis phase
# This solves the sensor timing issue: CFamily sensor processes coverage while indexing files
# Generic Coverage Report sensor runs BEFORE file indexing (can't apply coverage to non-existent files)
# Property: sonar.cfamily.gcov.reportsPath (CFamily-specific, processes during analysis)
# NOTE: SonarCloud only supports a single path - CI workflow merges all .gcov files to coverage-gcov/
sonar.cfamily.gcov.reportsPath=coverage-gcov

# Python
sonar.python.coverage.reportPaths=hatching_egg/coverage-python/coverage.xml

# Coverage exclusions
# Browser-only files that cannot be tested in Node.js environment
# - spider_crawl_projection/spider-animation.js: Browser canvas animation
# - hatching_egg/animation-behaviors.js: Uses top-level await + fetch() (browser-only)
# - hatching_egg/preview-app.js: DOM-dependent preview tool (development only)
# C++ test files (test_*.cpp) are excluded - coverage applies to header files they test
sonar.coverage.exclusions=**/*.test.js,**/*.spec.js,**/test*.js,**/test*.py,**/test_*.cpp,**/optimize-*.js,**/__tests__/**,**/jest.config.js,**/c8.config.json,**/arduino/**,**/public/**,**/spider-animation.js,hatching_egg/animation-behaviors.js,hatching_egg/preview-app.js

# Source encoding
sonar.sourceEncoding=UTF-8

# Additional settings
sonar.verbose=false

# C++ analysis enabled for hatching_egg header files and cmake_prototype
# Uses compilation database (compile_commands.json) generated by bear/cmake
# hatching_egg: Analyzes Arduino C++ header files (.h) where testable logic resides
# cmake_prototype: Analyzes standard C++ implementation
# Coverage: hatching_egg 85.9% (1621/1888 lines, 171 GoogleTest tests)
# Coverage: cmake_prototype 100% (native .gcov format)
# NOTE: SonarCloud only supports ONE compile_commands.json path
# Solution: Create merged compile_commands.json in CI workflow
sonar.cfamily.compile-commands=compile_commands.json
sonar.cpp.file.suffixes=.h,.cpp
sonar.c.file.suffixes=-
sonar.objc.file.suffixes=-

# Rule Exceptions (with documented rationale - Added Nov 10, 2025)
# Reference: spider_crawl_projection/SONARCLOUD_STRATEGY.md
# Reference: spider_crawl_projection/PHASE1_LESSONS_LEARNED.md
# Total exceptions: 89 issues (54 S7764 + 13 S7741 + 1 S107 + 2 S2234 + 1 css:S7924 + 18 S2245)

# S7764: Prefer globalThis over window (54 instances across 8 files)
# CRITICAL: spider_crawl_projection requires "window" for browser compatibility
# Changing to globalThis breaks browser exports - see PHASE1_LESSONS_LEARNED.md
# The pattern "typeof window !== 'undefined'" is REQUIRED for dual Node.js/browser modules
# Affected files: spider-animation.js, keyboard-controller.js, mode-controller.js,
#                 position-utils.js, boundary-utils.js, spider-factory.js,
#                 animation-math.js, config-defaults.js
sonar.issue.ignore.multicriteria=e1,e2,e3,e4,e5,e6

sonar.issue.ignore.multicriteria.e1.ruleKey=javascript:S7764
sonar.issue.ignore.multicriteria.e1.resourceKey=spider_crawl_projection/**/*.js

# S7741: Compare with undefined directly instead of using typeof (13 instances)
# CRITICAL: typeof operator is safer for checking undefined in browser/Node.js dual modules
# Direct comparison (window !== undefined) can throw ReferenceError if variable doesn't exist
# The typeof operator provides safe existence checking across environments
# The pattern guards against ReferenceError when checking for browser vs Node.js environment
# See: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/typeof#typeof_undeclared_variables
sonar.issue.ignore.multicriteria.e2.ruleKey=javascript:S7741
sonar.issue.ignore.multicriteria.e2.resourceKey=spider_crawl_projection/**/*.js

# S2245: Pseudorandom number generator (Math.random) security hotspot (18 instances)
# CONTEXT: spider_crawl_projection is a browser-based Halloween spider animation
# USE CASE: Math.random() used for non-cryptographic animation randomness:
#   - Random spider spawn positions (X/Y coordinates)
#   - Random hop angles and distances
#   - Random animation timing variations
#   - Random leg movement patterns
# SECURITY ANALYSIS: No security implications for visual animations
#   - Not used for authentication, authorization, or access control
#   - Not used for session tokens, passwords, or cryptographic keys
#   - Not exposed to network or user input validation
#   - Halloween display animation has no security requirements
# Affected files: spider-animation.js (5), hopping-logic.js (6), spider-factory.js (6), boundary-utils.js (1)
# Rule S2245: https://rules.sonarsource.com/javascript/RSPEC-2245
# Rationale: Visual randomness for Halloween animation != cryptographic randomness
sonar.issue.ignore.multicriteria.e6.ruleKey=javascript:S2245
sonar.issue.ignore.multicriteria.e6.resourceKey=spider_crawl_projection/**/*.js

# S107: Function has too many parameters (1 instance)
# TECHNICAL: calculateSwingPositionForCrawl requires 9 parameters for leg animation math
# All parameters are necessary and well-documented with JSDoc
# Refactoring to parameter object would require changing 15+ call sites
# Function is performance-critical in animation loop, current form is optimal
# Rationale: Performance > code smell in animation loop hot path
sonar.issue.ignore.multicriteria.e3.ruleKey=javascript:S107
sonar.issue.ignore.multicriteria.e3.resourceKey=spider_crawl_projection/animation-math.js

# S2234: Arguments in wrong order (2 instances)
# TECHNICAL: Computational geometry algorithm - direction() function
# The function computes cross product: (p3-p1) Ã— (p2-p1) to determine point orientation
# Parameter names are intentionally semantic (p1=line start, p2=line end, p3=test point)
# Call sites use different semantic names (p3, p4, p1, p2 for two line segments)
# The mathematical algorithm is correct; reordering would break intersection detection
# Affected files: optimize-foot-positions.js, optimize-individual-legs.js (dev tools)
# These are development optimization scripts, not production code
sonar.issue.ignore.multicriteria.e4.ruleKey=javascript:S2234
sonar.issue.ignore.multicriteria.e4.resourceKey=spider_crawl_projection/optimize-*.js

# css:S7924: Text contrast ratio (1 instance)
# UI/UX: spider-editor.html is a development tool, not user-facing production code
# The editor is used internally for leg position tuning
# Not covered by accessibility requirements for production Halloween display
# Exception justified: dev tool, not production
sonar.issue.ignore.multicriteria.e5.ruleKey=css:S7924
sonar.issue.ignore.multicriteria.e5.resourceKey=spider_crawl_projection/spider-editor.html
