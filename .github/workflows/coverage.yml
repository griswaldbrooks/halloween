name: Code Coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for SonarCloud
        lfs: true

    - name: Install Pixi
      uses: prefix-dev/setup-pixi@v0.5.1
      with:
        pixi-version: latest
        run-install: false

    - name: Test Hatching Egg with Coverage
      working-directory: ./hatching_egg
      run: |
        pixi install
        if pixi task list | grep -q "^coverage"; then
          pixi run coverage
        else
          echo "‚ö†Ô∏è  No coverage task defined for hatching_egg"
          echo "Running tests only"
          pixi run test
        fi

    - name: Test Spider Crawl Projection with Coverage
      working-directory: ./spider_crawl_projection
      run: |
        pixi install
        if pixi task list | grep -q "^coverage"; then
          pixi run coverage
        else
          echo "‚ö†Ô∏è  No coverage task defined for spider_crawl_projection"
          echo "Running tests only"
          pixi run test
        fi

    - name: Test Window Spider Trigger with Coverage
      working-directory: ./window_spider_trigger
      run: |
        pixi install
        if pixi task list | grep -q "^coverage"; then
          pixi run coverage
        else
          echo "‚ö†Ô∏è  No coverage task defined for window_spider_trigger"
          echo "Running tests only"
          pixi run test
        fi

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./window_spider_trigger/coverage/lcov.info,./spider_crawl_projection/coverage/lcov.info,./hatching_egg/coverage/lcov.info
        fail_ci_if_error: false
        verbose: true

    - name: SonarCloud Scan
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: https://sonarcloud.io

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          window_spider_trigger/coverage/
          spider_crawl_projection/coverage/
          hatching_egg/coverage/
        retention-days: 30

    - name: Coverage Summary
      if: always()
      run: |
        echo "üìä Coverage reports generated:"
        echo ""
        if [ -d "window_spider_trigger/coverage" ]; then
          echo "‚úÖ Window Spider Trigger coverage"
        fi
        if [ -d "spider_crawl_projection/coverage" ]; then
          echo "‚úÖ Spider Crawl Projection coverage"
        fi
        if [ -d "hatching_egg/coverage" ]; then
          echo "‚úÖ Hatching Egg coverage"
        fi
        echo ""
        echo "View detailed reports in the artifacts or on SonarCloud"
