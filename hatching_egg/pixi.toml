[workspace]
name = "hatching_egg"
version = "0.1.0"
description = "Hatching spider egg animatronic with kinematic preview"
channels = ["conda-forge"]
platforms = ["linux-64"]

[dependencies]
python = ">=3.11"
cxx-compiler = "*"  # C++ compiler for local tests
gtest = "*"  # Google Test framework for unit tests
lcov = "*"  # C++ code coverage
coverage = "*"  # Python code coverage (coverage.py)
bear = "*"  # Build EAR - generates compilation database for SonarCloud

[tasks]
# === Initial Setup ===
install-arduino-cli = "curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=.pixi/bin sh"

setup-arduino = { cmd = """
.pixi/bin/arduino-cli config init --config-file .arduino15/arduino-cli.yaml || true
.pixi/bin/arduino-cli core update-index --config-file .arduino15/arduino-cli.yaml
.pixi/bin/arduino-cli core install arduino:avr --config-file .arduino15/arduino-cli.yaml
.pixi/bin/arduino-cli lib install "Adafruit PWM Servo Driver Library" --config-file .arduino15/arduino-cli.yaml
echo "✓ Arduino AVR core and Adafruit library installed"
""", depends-on = ["install-arduino-cli"] }

setup = { depends-on = ["setup-arduino"] }

# === Preview Tasks ===
serve = "python -m http.server 8081"
open = "xdg-open http://localhost:8081/preview.html"

# === Testing ===
test-cpp = { cmd = "g++ -std=c++17 -I.pixi/envs/default/include test_servo_mapping.cpp -o test_servo_mapping -L.pixi/envs/default/lib -lgtest -pthread && LD_LIBRARY_PATH=.pixi/envs/default/lib ./test_servo_mapping", description = "Run C++ unit tests (44 gtest - per-servo ranges)" }
test-python = { cmd = "python -m unittest discover -s . -p 'test_*.py' -v", description = "Run all Python unit tests (test_servo_mapping.py + test_generate_arduino_config.py)" }
test-servo-tester = { cmd = "g++ -std=c++17 -I.pixi/envs/default/include test_servo_tester.cpp -o test_servo_tester -L.pixi/envs/default/lib -lgtest -pthread && LD_LIBRARY_PATH=.pixi/envs/default/lib ./test_servo_tester", description = "Run servo tester logic tests (34 gtest)" }
test-servo-sweep = { cmd = "g++ -std=c++17 -I. -I.pixi/envs/default/include test_servo_sweep.cpp -o test_servo_sweep -L.pixi/envs/default/lib -lgtest -pthread && LD_LIBRARY_PATH=.pixi/envs/default/lib ./test_servo_sweep", description = "Run servo sweep test logic tests (93 gtest)" }

# === C++ Coverage Tasks ===
test-cpp-coverage = { cmd = "bash -c 'g++ -std=c++17 --coverage -fprofile-arcs -ftest-coverage -I.pixi/envs/default/include test_servo_mapping.cpp -o test_servo_mapping_cov -L.pixi/envs/default/lib -lgtest -pthread && LD_LIBRARY_PATH=.pixi/envs/default/lib ./test_servo_mapping_cov && g++ -std=c++17 --coverage -fprofile-arcs -ftest-coverage -I.pixi/envs/default/include test_servo_tester.cpp -o test_servo_tester_cov -L.pixi/envs/default/lib -lgtest -pthread && LD_LIBRARY_PATH=.pixi/envs/default/lib ./test_servo_tester_cov && g++ -std=c++17 --coverage -fprofile-arcs -ftest-coverage -I. -I.pixi/envs/default/include test_servo_sweep.cpp -o test_servo_sweep_cov -L.pixi/envs/default/lib -lgtest -pthread && LD_LIBRARY_PATH=.pixi/envs/default/lib ./test_servo_sweep_cov && lcov --capture --directory . --output-file coverage-cpp.info && lcov --remove coverage-cpp.info \"/usr/*\" --output-file coverage-cpp-filtered.info && genhtml coverage-cpp-filtered.info --output-directory coverage-cpp && echo \"C++ coverage report generated in coverage-cpp/index.html\"'", description = "Run C++ tests with coverage" }

# === Compilation Database for SonarCloud ===
# This task generates compile_commands.json that tells SonarCloud which C++ files to analyze
# Step 1: Compile test files (captures test_*.cpp in compilation DB)
# Step 2: Compile coverage_compilation.cpp (captures header .h files in compilation DB)
# Result: SonarCloud can match header files between compilation DB and coverage report
generate-compile-db = { cmd = "bash -c 'rm -f compile_commands.json && bear --output compile_commands.json -- bash -c \"g++ -std=c++17 --coverage -fprofile-arcs -ftest-coverage -I.pixi/envs/default/include test_servo_mapping.cpp -o test_servo_mapping_cov -L.pixi/envs/default/lib -lgtest -pthread && g++ -std=c++17 --coverage -fprofile-arcs -ftest-coverage -I.pixi/envs/default/include test_servo_tester.cpp -o test_servo_tester_cov -L.pixi/envs/default/lib -lgtest -pthread && g++ -std=c++17 --coverage -fprofile-arcs -ftest-coverage -I. -I.pixi/envs/default/include test_servo_sweep.cpp -o test_servo_sweep_cov -L.pixi/envs/default/lib -lgtest -pthread\" && bear --append --output compile_commands.json -- g++ -std=c++17 -c coverage_compilation.cpp -I. -Iarduino && echo \"✅ Compilation database generated with header files: compile_commands.json\"'", description = "Generate compilation database for SonarCloud C++ analysis (includes header files)" }

# === Python Coverage Tasks ===
test-python-coverage = { cmd = "bash -c 'python -m coverage run -m unittest discover -s . -p \"test_*.py\" && python -m coverage html -d coverage-python && python -m coverage xml -o coverage-python/coverage.xml && python -m coverage report && echo \"Python coverage report generated in coverage-python/index.html\"'", description = "Run all Python tests with coverage" }
test-kinematics = { cmd = "node test_leg_kinematics.js", description = "Run leg kinematics tests (31 tests)" }
test-animation-behaviors = { cmd = "node test_animation_behaviors.js", description = "Run animation behaviors tests (10 tests)" }
test = { depends-on = ["test-cpp", "test-python", "test-servo-tester", "test-servo-sweep", "test-kinematics", "test-animation-behaviors"], description = "Run all tests (232 total - includes buffer overflow prevention)" }
test-before-upload = { depends-on = ["test"], description = "Run safety tests before hardware upload" }
test-coverage = { cmd = "npx c8 --reporter=html --reporter=lcov --reporter=text --include='*.js' --exclude='test_*.js' --exclude='arduino/**' --exclude='scripts/**' --report-dir=coverage-js bash -c 'node test_leg_kinematics.js && node test_animation_behaviors.js'", description = "Run JavaScript tests with coverage" }

# === Combined Coverage ===
coverage-js-only = { cmd = "npx c8 --reporter=html --reporter=lcov --reporter=text --include='*.js' --exclude='test_*.js' --exclude='arduino/**' --exclude='scripts/**' --report-dir=coverage-js bash -c 'node test_leg_kinematics.js && node test_animation_behaviors.js'", description = "Run JavaScript tests with coverage" }

coverage-all = { cmd = "bash -c 'set -e && echo \"Running JavaScript coverage...\" && pixi run coverage-js-only && echo && echo \"Running C++ coverage...\" && pixi run test-cpp-coverage && echo && echo \"Running Python coverage...\" && pixi run test-python-coverage && echo && echo \"================================================\" && echo \"Coverage reports generated:\" && echo \"  - JavaScript: coverage-js/index.html\" && echo \"  - C++:        coverage-cpp/index.html\" && echo \"  - Python:     coverage-python/index.html\" && echo \"================================================\"'", description = "Run all tests with coverage (JS, C++, Python)" }

coverage = { depends-on = ["coverage-all"], description = "Generate all code coverage reports" }
view-coverage-js = { cmd = "xdg-open coverage-js/index.html", description = "Open JavaScript coverage report" }
view-coverage-cpp = { cmd = "xdg-open coverage-cpp/index.html", description = "Open C++ coverage report" }
view-coverage-python = { cmd = "xdg-open coverage-python/index.html", description = "Open Python coverage report" }
view-coverage = { cmd = """
xdg-open coverage-js/index.html
xdg-open coverage-cpp/index.html
xdg-open coverage-python/index.html
""", description = "Open all coverage reports in browser" }

# === Arduino Tasks ===
generate-config = "python generate_arduino_config.py"
arduino-detect = ".pixi/bin/arduino-cli board list --config-file .arduino15/arduino-cli.yaml"
upload = { cmd = "bash scripts/upload.sh", depends-on = ["test-before-upload", "generate-config"] }
monitor = ".pixi/bin/arduino-cli monitor -p $(.pixi/bin/arduino-cli board list --config-file .arduino15/arduino-cli.yaml | grep 'Arduino Leonardo' | awk '{print $1}' | head -n 1) --config-file .arduino15/arduino-cli.yaml"

# === Servo Calibration Tasks ===
calibrate = "bash scripts/upload_servo_tester.sh"

# === Animation Tester Tasks ===
test-animations = "bash scripts/upload_animation_tester.sh"

# === Servo Sweep Test Tasks ===
sweep-upload = "bash scripts/upload_sweep_test.sh"
sweep-monitor = ".pixi/bin/arduino-cli monitor -p $(.pixi/bin/arduino-cli board list --config-file .arduino15/arduino-cli.yaml | grep 'Arduino Leonardo' | awk '{print $1}' | head -n 1) --config-file .arduino15/arduino-cli.yaml"

# === Troubleshooting ===
fix-permissions = """
echo "Adding user to dialout group..."
sudo usermod -a -G dialout $USER
echo "✓ Done! You must log out and back in for this to take effect."
"""

[tasks.status]
cmd = """
echo "Hatching Egg Spider - Kinematic Preview"
echo "========================================"
echo ""
echo "Available commands:"
echo "  pixi run setup          - First time setup (arduino-cli)"
echo "  pixi run serve          - Start HTTP server on port 8081"
echo "  pixi run open           - Open preview in browser"
echo "  pixi run generate-config- Generate Arduino config from JSON"
echo "  pixi run arduino-detect - Detect connected Beetle"
echo "  pixi run upload         - Upload production code to Beetle"
echo "  pixi run test-animations- Upload animation tester (interactive)"
echo "  pixi run monitor        - Serial monitor"
echo ""
echo "Preview: http://localhost:8081/preview.html"
"""
