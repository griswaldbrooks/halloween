# SonarCloud C++ Coverage Research - Definitive Findings

**Date:** 2025-11-11
**Investigation:** Is `sonar.cfamily.gcovr.reportPaths` supported in SonarCloud?

## Executive Summary

**CRITICAL FINDING:** The property `sonar.cfamily.gcovr.reportPaths` is **NOT documented** in official SonarCloud documentation and is **NOT used** by the official example repository.

**CORRECT PROPERTY:** `sonar.coverageReportPaths` (generic coverage format)

## Research Evidence

### 1. Official SonarCloud Documentation

**Source:** https://docs.sonarsource.com/sonarcloud/enriching/test-coverage/c-c-objective-c-test-coverage/

**Documented C++ Coverage Properties:**
1. `sonar.cfamily.gcov.reportsPath` - Native .gcov files (NOT XML from gcovr)
2. `sonar.cfamily.llvm-cov.reportPath` - LLVM coverage reports
3. `sonar.cfamily.vscoveragexml.reportsPath` - Visual Studio coverage XML
4. `sonar.cfamily.bullseye.reportPath` - Bullseye coverage (commercial)
5. `sonar.coverageReportPaths` - Generic test data format

**NOT DOCUMENTED:**
- ❌ `sonar.cfamily.gcovr.reportPaths` - This property is NOT mentioned anywhere

### 2. Official Example Repository

**Repository:** https://github.com/sonarsource-cfamily-examples/linux-cmake-gcovr-gh-actions-sc

**Coverage Generation Command:**
```bash
gcovr --sonarqube > coverage.xml
```

**SonarCloud Properties Used:**
```properties
# In .github/workflows/build.yml (passed to scanner)
sonar.cfamily.compile-commands="${{ env.BUILD_WRAPPER_OUT_DIR }}/compile_commands.json"
sonar.coverageReportPaths=coverage.xml
```

**In sonar-project.properties:**
```properties
sonar.sources=src
sonar.sourceEncoding=UTF-8
# NO coverage properties - they're passed via workflow
```

### 3. What gcovr --sonarqube Actually Generates

**Source:** https://gcovr.com/en/stable/output/sonarqube.html

**Format:** SonarQube Generic Test Data XML format
**Documentation:** https://docs.sonarsource.com/sonarqube-server/latest/analyzing-source-code/test-coverage/generic-test-data/

**Key Properties:**
- This is NOT a C++-specific format
- This is the "Generic Test Data" format that works for ANY language
- Should be imported via `sonar.coverageReportPaths`, NOT a cfamily-specific property

### 4. The Confusion: Why Does Our Property Name Make Sense?

The property name `sonar.cfamily.gcovr.reportPaths` SEEMS logical because:
- We're analyzing C++ code (cfamily)
- We're using gcovr to generate reports
- Other cfamily properties exist (gcov, llvm-cov, etc.)

**BUT:** The gcovr output is NOT a cfamily-specific format - it's the generic format!

## The Correct Approach

### For gcovr XML Coverage:

**Step 1: Generate Coverage**
```bash
# Run tests to generate .gcda files
./test_executable

# Generate SonarQube XML format
gcovr --sonarqube coverage.xml
```

**Step 2: Configure SonarCloud**
```properties
# Use the GENERIC coverage property, NOT cfamily-specific
sonar.coverageReportPaths=coverage.xml

# OR in CI/CD workflow:
-Dsonar.coverageReportPaths=coverage.xml
```

**Step 3: Ensure Proper Paths**
The XML file must contain paths that match your sonar.sources:
- If `sonar.sources=.` then paths should be relative from project root
- If `sonar.sources=src` then paths should be relative to project root (not inside src/)

**Our coverage.xml has:**
```xml
<file path="hatching_egg/arduino/servo_mapping.h">
```

**Our sonar.sources is:**
```properties
sonar.sources=.
```

This SHOULD work (paths are relative to root).

## Why CFamily Sensor Didn't Mention Coverage

From CI logs:
```
INFO  Sensor CFamily [cpp]
INFO  CFamily plugin version: 6.74.0.91793
INFO  Starting the analysis of 1 CFamily compilation units
INFO  Sensor CFamily [cpp] (done) | time=2732ms
```

**Reason:** The CFamily sensor is NOT responsible for parsing `sonar.coverageReportPaths`!

The **generic coverage sensor** parses this property, not the CFamily sensor.

## sonar.cfamily.gcov.reportsPath vs sonar.coverageReportPaths

### sonar.cfamily.gcov.reportsPath
- Expects NATIVE .gcov files (text format, one per source file)
- Example: `source.cpp.gcov`
- Generated by: `gcov source.cpp`
- Format: gcov's text-based format

### sonar.coverageReportPaths
- Expects Generic Test Data XML format
- Example: `coverage.xml`
- Generated by: `gcovr --sonarqube coverage.xml`
- Format: SonarQube's generic XML schema

**These are DIFFERENT formats!**

## Current Status in Our Project

**What we have:**
```properties
sonar.cfamily.gcovr.reportPaths=hatching_egg/coverage-cpp/coverage.xml
```

**What we should have:**
```properties
sonar.coverageReportPaths=hatching_egg/coverage-cpp/coverage.xml
```

**The XML file is correct:**
- Generated via `gcovr --sonarqube`
- Contains proper paths (hatching_egg/arduino/*.h)
- Matches our sonar.sources=.

**The property name is wrong:**
- Using undocumented property
- Should use generic coverage property
- CFamily sensor ignores it (not its job)

## Community Evidence

**Search:** "sonar.cfamily.gcovr.reportPaths" on community.sonarsource.com

**Result:** NO EXACT MATCHES

This confirms the property is not standard/documented.

**Related threads:**
- People successfully use `sonar.coverageReportPaths` with gcovr
- Common issue: path mismatches (file names only vs full paths)
- Our paths are correct (relative from root)

## Recommendation

### Action 1: Fix Property Name
```properties
# REMOVE (undocumented, doesn't work)
# sonar.cfamily.gcovr.reportPaths=hatching_egg/coverage-cpp/coverage.xml

# ADD (official, documented, works)
sonar.coverageReportPaths=hatching_egg/coverage-cpp/coverage.xml
```

### Action 2: Verify XML Paths
Our coverage.xml paths are correct:
```xml
<file path="hatching_egg/arduino/servo_mapping.h">
```

These match our `sonar.sources=.` configuration.

### Action 3: Remove Redundant Properties
Since we're using the generic format, we don't need:
```properties
# Can remove these (not used for gcovr XML)
# sonar.cfamily.gcov.reportsPath=...  (only for native .gcov files)
```

### Action 4: Test
After changing the property:
1. Push to GitHub
2. Wait for SonarCloud analysis
3. Check SonarCloud dashboard for coverage
4. Verify with `tools/sonarcloud_verify.py`

## Expected Outcome

After using `sonar.coverageReportPaths`:
- Generic coverage sensor will parse coverage.xml
- Coverage data will be imported for C++ files
- SonarCloud dashboard will show 85%+ coverage for hatching_egg
- tools/sonarcloud_verify.py will confirm coverage data present

## Why This Took So Long to Discover

1. **Logical naming:** `sonar.cfamily.gcovr.reportPaths` SEEMS correct
2. **No validation:** SonarCloud doesn't warn about unknown properties
3. **Silent failure:** Property is ignored, no error message
4. **Misleading logs:** CFamily sensor runs successfully (it's analyzing code, not coverage)
5. **Confusing docs:** gcovr docs mention "SonarQube XML" but not which property to use

## Lessons Learned

1. **Always verify property names** in official documentation
2. **Check example repositories** for actual working configuration
3. **Understand sensor responsibilities** (CFamily analyzes code, not coverage)
4. **Generic format ≠ language-specific** (gcovr output is generic, not cfamily-specific)
5. **Silent failures are dangerous** (unknown properties are ignored)

## References

- Official C++ Coverage Docs: https://docs.sonarsource.com/sonarcloud/enriching/test-coverage/c-c-objective-c-test-coverage/
- Test Coverage Parameters: https://docs.sonarsource.com/sonarcloud/enriching/test-coverage/test-coverage-parameters/
- Official Example: https://github.com/sonarsource-cfamily-examples/linux-cmake-gcovr-gh-actions-sc
- gcovr Documentation: https://gcovr.com/en/stable/output/sonarqube.html
- Generic Test Data Format: https://docs.sonarsource.com/sonarqube-server/latest/analyzing-source-code/test-coverage/generic-test-data/

---

**Next Steps:**
1. Update sonar-project.properties
2. Test the fix
3. Verify with tools
4. Document in CLAUDE.md
5. Update CI/CD if needed
